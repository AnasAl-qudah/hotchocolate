using System;
using System.Collections.Generic;
using HotChocolate.Execution.Processing;
using HotChocolate.Language;
using HotChocolate.Types;

namespace HotChocolate.Stitching.Execution;

internal sealed class RemoteQueryPlaner
{
    private StitchingMetadataDb _metadataDb;

    public RemoteQueryPlaner(StitchingMetadataDb metadataDb)
    {
        _metadataDb = metadataDb ?? throw new ArgumentNullException(nameof(metadataDb));
    }

    public QueryNode Build(IPreparedOperation operation)
    {
        if (operation is null)
        {
            throw new ArgumentNullException(nameof(operation));
        }

        return Visit(operation);
    }

    private QueryNode Visit(IPreparedOperation operation)
    {
        ISelectionSet rootSelectionSet = operation.GetRootSelectionSet();
        ISelection first = rootSelectionSet.Selections[0];
        NameString source = _metadataDb.GetSource(first);
        QueryNode root = new QueryNode(source);
        RemoteQueryPlanerContext context = new RemoteQueryPlanerContext(operation, root);
        context.Syntax.Push(default);

        Visit(rootSelectionSet, context);

        ISyntaxNode? node = context.Syntax.Pop();

        if (node is not SelectionSetNode selectionSetSyntax)
        {
            throw new InvalidOperationException();
        }

        var operationSyntax = new OperationDefinitionNode(
            null,
            null,
            operation.Definition.Operation,
            Array.Empty<VariableDefinitionNode>(),
            Array.Empty<DirectiveNode>(),
            selectionSetSyntax);

        root.Document = new DocumentNode(null, new[] { operationSyntax });

        return root;
    }

    private void Visit(ISelectionVariants selectionVariants, RemoteQueryPlanerContext context)
    {

    }

    private void Visit(ISelectionSet selectionSet, RemoteQueryPlanerContext context)
    {
        Enter(selectionSet, context);

        var currentNode = context.CurrentNode;
        var set = new HashSet<ISelection>();

        foreach (ISelection selection in selectionSet.Selections)
        {
            if (_metadataDb.IsPartOfSource(currentNode.Source, selection))
            {

            }
        }

        while (buffered.Count > 0)
        {
            while (buffered.Count < index)
            {

            }

            if (buffered.Count > 0)
            {

            }
        }

        foreach (ISelection selection in selectionSet.Selections)
        {
            if (metadataDb.IsPartOfSource(currentNode.Source, selection))
            {
                Visit(selection, context);
            }
            else
            {

            }
        }

        Leave(selectionSet, context);
    }

    private void Enter(ISelectionSet selectionSet, RemoteQueryPlanerContext context)
    {

    }

    private void Leave(ISelectionSet selectionSet, RemoteQueryPlanerContext context)
    {

    }

    private void Visit(ISelection selection, RemoteQueryPlanerContext context)
    {
        Enter(selection, context);

        if (selection.SelectionSet is not null)
        {
            foreach (ObjectType possibleType in
                context.Operation.GetPossibleTypes(selection.SelectionSet))
            {
                ISelectionSet selectionSet =
                    context.Operation.GetSelectionSet(selection.SelectionSet, possibleType);
                Visit(selectionSet, context);
            }
        }

        Leave(selection, context);
    }

    private void Enter(ISelection selection, RemoteQueryPlanerContext context)
    {

    }

    private void Leave(ISelection selection, RemoteQueryPlanerContext context)
    {

    }
}
